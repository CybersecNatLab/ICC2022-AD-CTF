#!/usr/bin/env python3
import sys
from hashlib import sha256
from Crypto.Cipher import AES
from service2_store2_common import Client, register_random_user, get_token, bits2bytes, xor, get_b

load("service2_store2_common_sage.sage")

def my_reconstruct(c):
    poss = [0]
    for j in range(41):
        p = 1 << j
        new_poss = []
        for Rcur in poss:
            for bit in range(2):
                Rnew = Rcur + bit*p
                vals = [(x[1]-(x[0] ^^ Rnew)) % (2*p) for x in c]
                if all(vals[0] == x for x in vals):
                    new_poss.append(Rnew)
        poss = new_poss
    return min(poss)


def exploit(ip, target_user):
    username, password = register_random_user(ip)
    token = get_token(ip, username, password)
    client = Client(ip, token)
    pub = bytes.fromhex(client.get_public(target_user))
    circ, (N, cc, xx) = client.run_function(2, target_user, b"\0"*16)
    m = [el[0] for el in cc]

    R = my_reconstruct(cc)
    enc_B_all = [[x, x ^^ R] for x in m]
    enc_B_all = [[f'{x[0]:010x}', f'{x[1]:010x}'] for x in enc_B_all]

    bdata = get_b(circ["gates"], circ["enc_A"], enc_B_all)
    keys = get_key(bdata)
    for key in keys:
        cipher = AES.new(key, AES.MODE_ECB)
        flag = cipher.decrypt(pub)
        try:
            return flag.decode()
        except UnicodeDecodeError:
            continue


if __name__ == "__main__":
    team_id = sys.argv[1]
    flag_id = sys.argv[2]
    ip = f"10.60.{team_id}.1"
    print(exploit(ip, flag_id))
